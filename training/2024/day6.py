"""https://adventofcode.com/2024/day/6"""

import numpy as np
from typing import Generator

example_input = """
....#.....
.........#
..........
..#.......
.......#..
..........
.#..^.....
........#.
#.........
......#...
"""

actual_input = """................#.................#.#...........................#.#..................#............................................
..........#................#...........#...................#.#....................................................................
....#......#......#............#.#........#..........#.......#.......#...#........#..........#.........................#..........
..................#............#.....##...............#..#.....................#...........#......................................
#.........#.............................................................#........#............#........#.....#...#...........#....
.....#...#......#..................................................#........#..................#......#.......................#...
#.................................................#......................#......#...................................#.............
...#.#...#.....................................#.......................#.........#..................................#....#........
..............................................#..............#...#...........##..........................#.......#............#...
........#.#.......#.................##.......................#..........#...........................#...#.........................
.................#..............................#.................#............#....#.....#.......................................
.................................................................#......#............#.#.#..................#.....................
.#..........#......#...#.......#..........................#....................#.#.............................#..................
...............#.....##.......#..#...###......#......................#.................................#.#......#..#..............
#.....................#......................................#..........#...............#........#...............#...#.#..........
.......................................#..................#.........................#.............................................
.......................#...............................................................#........................#...........#.....
......#....#..........................................................................................#..........#................
........#.......................................#..........................#.............##.........#............#.#.........#....
......#........#........................................................#..........................#..............................
....................#.................................................#.....................#......#..#...#....................#..
...........#....................##.....#...#............#...#......................................#.....#.......#.........#....#.
#..............#.................#......#..................#...................#......#...........#...............................
.......#.......#.........................................#.....#..#.................................................#..........#..
..#..................#.......................#..#..#...#..........................#.........#...##......#..........#.#..#.........
..#.........#....................#...........................#....................#..........................#................#..#
......#.....................................................#..#.......#.............#...................#......................#.
.....#..................................................................#...#.....................#......................#.#......
......#..............#...................................#.......................#...................................#...##.......
...........#..........#....................................................................#........................#.............
#.......................................#..........................#........#......#......................##......................
.............#...#..........#......#..........#.#......................................................................#..........
........................................................#....#...#......##..........................#..........#..................
.#...#.....#..........#....#...........................................#........#....................................#............
....#....................................##.......#...........................................#.......#...........................
...........#.............#........................................................#...#................#........#.................
.....#.#........................................#....................#.........#..................................................
.........#............#..............................#...#..............#...........................#...............#.....#.......
......................#........................................#.#..........#...#..#......................#.......................
##...........#..............#......#....................#..........................#.......................#.......#.......#......
....#..#.........................................................#.....#..#.........................................#.....#.......
....#......##................#......................................#.......................................#..................#..
..............................#............................#..................#.......#.......#..................#...#............
......................................................#............................#..............................................
.......#.............................#......#.................................#...................................................
..................................................................................................................#...............
.......................#.....#...........##........................................#..............................#...............
..........................#................................................................#..................#...................
..........................#..................#........#..............#.#..#...................##..................................
..................#............................................................................................#..................
.......................#..........#...##................#.........................................................................
...............#.....................................#............................................#...............................
....#..................................................................................#........#.................................
..#................#.....................................................................#...#....................................
..........#.............#.........#......#................#......#.........#........#.......................#.....................
..........................................................................#.................................#.....#....#.#........
....#..........#......................................#......................................................#.......#....#.....#.
.....#...............................#............................#........................................................#......
.............................................................................#.......................#....................#..#....
................#.............................................................#...................................................
.....#................#.......#....................#............#.......#.....#.................................#.................
...........................................................................................................#.#....................
.....#...............................................#...................................................................#..#.....
................#..............................#.............#.#..............................................................#...
..#............#...................#..................................................................#...............#...#....#..
..........#...............#...............#............................................#......#...##........#..#..................
......#..###..........................................................................................#................#..........
..........#........#.....#.......................#.........................................#.#........#.#.........................
.....#............................................................#.....#..........................#..............................
...............................................................#..............#........................................#..........
.................................................#....#...#....................................#..#........................#......
.................#..........#......#......................#.......#...................#.#.........................................
.#............................................................................#..............#..............................#..#..
..#........#...#..........#.................#...#...................................................#...#............#............
...........#.......#..#...............................................................................#...........................
.#.#..#...........##...................#...................................#...........#...............................#..........
......................................................................#............#.....................................#...#....
....#............#.#.#................#............#....#...#......#....................................................#.........
.......................................................................................#.....................................#....
.......................................#..................#........#................................................#.............
.........................................#.....#..........#.......##..................................#................#..........
..............#.............#............#..........................................................#.............................
.#...................#...#..........................................................#........#........#..........................#
..#..............................#.....................................#.................#.............#...........#..............
.................................#........................#.#....#......#....................#....................................
.#..................................................#.....#............................#..........#..................#.......#....
.....................#.......................^............#...#...#..............#................#...............................
.........#....................................#....................#...........#...........#..............#...................#...
............................#...........#....................#.............#.......#.......................#...#....#.............
............#.................#...........#..................................................................#............#.......
...........#....................#.................................................#......#.#....................#.................
..............................................................#..........#........#....#.........#................................
...............#.........#......#..........#.#.............................................................................#....#.
...............##...##..........................................................................................#.................
..........................#.#...........................#......................#...............#..................................
.....#...#..................#...........#....#.........#............................#.............................................
.........................................................................................#...................#...#................
............#.....................#...........#..................................................................#................
.#.............................#............................#..........#......##...................................#.#............
............#.........................................#...............................................#.#....#....................
.........................................................#..#.#...............#......#....#........#..........................#...
............................#..#.................#................................................................#...............
............................#.........................................................................#....#..#............#..#...
....#........#....#....#..#..............................#...#......................#.......................#............#........
..#...............#............................................................................................................#..
#.......................#...#............#..................................................#.........................#...........
.....#.................#..#.............................................#...................................................##....
...............#....................................#................#.........................#.#...........................#.#..
.................#....#....#..............#....#.#....#...............#......................#...............#..................#.
...........#...............................................................................#....#.................#...............
...............#............................................###.#.#.#........#...................................#....#...........
................#.................#........#............#..............#.....................#.............#......................
....................................#.....................................................#....#..................................
..#..#.............#......#.#..................#........................................#..........#...#..........................
...............#........................#...............................#.............#...................#..#....#...............
......#...........................#..............................................#..............................#...............#.
...........#..............#................#....#..........#................#.......#..............#.........#.................#..
......#....................................................................................................#......................
...........#.............#...............#..........#....#.#...##..................#....................#.........................
.......................................................#.#.....................................#..................#.......#.......
...............#...............#...........................................................................#..................#...
...............#......#.........#..................#.............................#..............................#.................
...............#..........#..#.......#.............#............................#.#............................#..................
..........#................................#..#...................................................................................
..#................#............#........#...................................#...............##.................##....#.......#...
..#.....................................................................#.............................................#.#.........
#...#...#.......................##............#..............#.........#......................#........#.#........................
..............................#......#.......#.........#...#..#.......................................................#.#.........
.#..................#.#................................#..........#.......#..........................#............................
...............#.....................#...#..........................................#..........#......#...........................
"""


def find_initial_coords(grid: np.ndarray) -> tuple[int, int]:
    lines, cols = grid.shape
    for l in range(lines):
        for c in range(cols):
            if grid[l, c] == "^":
                print(f"guard's initial coords: {(l, c)}")
                return (l, c)
    raise Exception("Guard's initial coords not found")


def solve_p1(inp: str) -> tuple[int, set]:
    grid = np.array([list(line) for line in inp.splitlines() if line.strip()])
    # locate guard's initial coords
    l, c = find_initial_coords(grid)
    grid_nb_lines, grid_nb_cols = grid.shape
    current_dir = "u"
    visited = set()
    while 0 <= l < grid_nb_lines and 0 <= c < grid_nb_cols:
        visited.add((l, c))
        if current_dir == "u":
            if l == 0:
                break
            if grid[l - 1, c] == "#":
                current_dir = "r"
                c += 1
            else:
                l -= 1
        elif current_dir == "r":
            if c == grid_nb_cols - 1:
                break
            if grid[l, c + 1] == "#":
                current_dir = "d"
                l += 1
            else:
                c += 1
        elif current_dir == "d":
            if l == grid_nb_lines - 1:
                break
            if grid[l + 1, c] == "#":
                current_dir = "l"
                c -= 1
            else:
                l += 1
        else:
            if c == 0:
                break
            if grid[l, c - 1] == "#":
                current_dir = "u"
                l -= 1
            else:
                c -= 1

    print(f"part1 : {len(visited)}")
    return len(visited), visited


# part2

def is_loop(grid: np.ndarray, initial_coords: tuple[int, int]) -> bool:
    l, c = initial_coords
    grid_nb_lines, grid_nb_cols = grid.shape
    current_dir = "u"
    visited = (
        set()
    )  # now Il'l also keep track of the direction in addition to the coords
    while 0 <= l < grid_nb_lines and 0 <= c < grid_nb_cols:
        if ((l, c), current_dir) in visited:
            return True
        visited.add(((l, c), current_dir))
        if current_dir == "u":
            if l == 0:
                break
            if grid[l - 1, c] != "#":
                l -= 1
            elif grid[l, c + 1] != "#":
                current_dir = "r"
                c += 1
            else:
                current_dir = "d"

        elif current_dir == "r":
            if c == grid_nb_cols - 1:
                break
            if grid[l, c + 1] != "#":
                c += 1
            elif grid[l + 1, c] != "#":
                current_dir = "d"
                l += 1
            else:
                current_dir = "l"
        elif current_dir == "d":
            if l == grid_nb_lines - 1:
                break
            if grid[l + 1, c] != "#":
                l += 1
            elif grid[l, c - 1] != "#":
                current_dir = "l"
                c -= 1
            else:
                current_dir = "u"
        else:
            if c == 0:
                break
            if grid[l, c - 1] != "#":
                c -= 1
            elif grid[l - 1, c] != "#":

                current_dir = "u"
                l -= 1
            else:
                current_dir = "r"
    return False


def place_obstructions(
    grid: np.ndarray, visited: set[tuple[int, int]]
) -> Generator[np.ndarray, None, None]:
    for l, c in visited:
        if grid[l, c] != ".":
            continue
        grid[l, c] = "#"
        yield grid
        grid[l, c] = "."


def solve_p2(inp: str) -> int:
    grid = np.array([list(line) for line in inp.splitlines() if line.strip()])
    # locate guard's initial coords
    l, c = find_initial_coords(grid)
    _, visited_spots = solve_p1(
        inp
    )  # it makes sense to place an obstruction only on visited places: reuse part1
    ans = sum(
        is_loop(new_grid, (l, c))
        for new_grid in place_obstructions(grid, visited_spots)
    )
    print(f"part2: {ans}")  # 1770: too high
    return ans


if __name__ == "__main__":
    assert solve_p1(example_input)[0] == 41
    solve_p1(actual_input)
    assert solve_p2(example_input) == 6
    solve_p2(actual_input)
